<!DOCTYPE html>
<html>
<head>        
  <title>Inquty player</title>

</head>

<body>
  <p>Simple example of using the Web Audio API to load a sound file and start playing it on user-click.</p>
  <input type="file" accept="audio/*" class="button">
  <button onclick="playSound()" disabled="">Start</button>
  <button onclick="stopSound()" disabled="">Stop</button>

  <canvas width="400" height="120" id="canvas" />

  <script>
    if (!window.webkitAudioContext) {
      alert('The Web Audio API is not supported in your browser!');
    }
    var context = new window.webkitAudioContext();
    var source = null;
    var audioBuffer = null;
    var analyser = context.createAnalyser();

    function stopSound() {
      if (source) {
        source.stop(0);
      }
    }

    function playSound() {
      source = context.createBufferSource(); // Global so we can .noteOff() later.
      source.buffer = audioBuffer;
      source.loop = false;
      analyser.fftSize = 2048;
      
      source.connect(analyser);
      analyser.connect(context.destination);
      source.start(context.currentTime);
      window.setInterval(update, 20); 
    }

    function initSound(arrayBuffer) {
      context.decodeAudioData(arrayBuffer, function(buffer) {
        audioBuffer = buffer;
        var buttons = document.querySelectorAll('button');
        buttons[0].disabled = false;
        buttons[1].disabled = false;
      }, function(e) {
        console.log('Error decoding', e);
      }); 
    }

    var canvas = document.getElementById("canvas");
    var canvas_context = canvas.getContext("2d");

    function update() {
      // This graph has 30 bars.      
      var num_bars = 50;
      // Get the frequency-domain data
      var data = new Uint8Array(2048);
      analyser.getByteFrequencyData(data);
      
      // Clear the canvas
      canvas_context.clearRect(0, 0, 400, 150);

      // Break the samples up into bins
      var bin_size = Math.floor(400 / num_bars);
      for (var i=0; i < num_bars; ++i) {
        var sum = 0;
        for (var j=0; j < bin_size; ++j) {
          sum += data[(i * bin_size) + j];
        }

        // Calculate the average frequency of the samples in the bin
        var average = sum / bin_size;

        // Draw the bars on the canvas
        var bar_width = canvas.width / num_bars;
        var scaled_average = (average / 256) * canvas.height;

        canvas_context.fillRect(i * bar_width, canvas.height, bar_width - 2,
                             -scaled_average);
    }
  }
   
    


    document.querySelector('input[type="file"]').addEventListener('change', function(e) {  
      var reader = new FileReader();
      reader.onload = function(e) {
        initSound(e.target.result);
      };
      reader.readAsArrayBuffer(e.target.files[0]);
    }, false);

    // Example loading via xhr2: loadSoundFile('sounds/A220_A880.wav');
    function loadSoundFile(url) {
      var request = new XMLHttpRequest();
      request.open('GET', url, true);
      request.responseType = 'arraybuffer';
      request.onload = function(e) {
        initSound(e.target.response);
      };
      request.send();
    }
    </script>


    </body>

</html>



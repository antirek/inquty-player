<!DOCTYPE html>
<html>
    <head>
        <title></title>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
        <script src="http://yandex.st/jquery/2.0.0/jquery.js" type="text/javascript"></script>
        <script type="text/javascript" src="http://cdn.jsdelivr.net/mediaelement/2.11.0/mediaelement-and-player.js"></script>
        <link type="text/css" rel="stylesheet" href="http://cdn.jsdelivr.net/mediaelement/2.11.0/mediaelementplayer.css" />
        <link href="//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/css/bootstrap-combined.min.css" rel="stylesheet">

        <script type="text/javascript" src="mep-feature-playlist/mep-feature-playlist.js"></script>
        <script type="text/javascript" src="mep-feature-vk/mep-feature-vk.js"></script>        
        <script src="http://vk.com/js/api/openapi.js" type="text/javascript"></script>

        <link type="text/css" rel="stylesheet" href="mep-feature-playlist/mep-feature-playlist.css" />
        <style>
            html { 
                background: url(images/background.jpg) no-repeat center center fixed; 
                -webkit-background-size: cover;
                -moz-background-size: cover;
                -o-background-size: cover;
                background-size: cover;
            }
            body{

                background-color: transparent;
            }

        </style>


    </head>
    <body>

        <div class="container">
            <div class="row">
                <div class="span8 offset3">
                    <div id="login_button" onclick="VK.Auth.login(authInfo, 8);"></div>
                    <div id="userinfo"></div>

                    <div id="audioUrl"></div>                 
                </div>
                <div class="span2"> 
                    <a href="#" onclick="getRecommendAudioList();">Recommend</a><br/>
                    <a href="#" onclick="getPopularAudioList();">Popular</a><br/>
                    <a href="#" onclick="getAudioList();">My songs</a><br/><br/>
                    <input id="search" type="text"><br/>
                    <a href="#" onclick="search1();">Search</a><br/><br/>



                    <div id="albums"></div>

                    <div id="output"></div>
                </div>

            </div>


        </div>




        <script language="javascript">
                        var jk;
                        var current_user_id;
                        function authInfo(response) {
                            if (response.session) {
                                $('#login_button').hide();
                                current_user_id = response.session.mid;
                                loadProfile(response.session.mid);
                                console.log(response.session.mid);
                            } else {
                                $('#login_button').show();
                            }
                        }

                       


                     

                        function processData(data) {
                            alert(data);
                        }

                        function loadAlbums() {


                            VK.api("audio.getAlbums", {
                                count: 100,
                                owner_id: current_user_id
                            },
                            function(data) {
                                if (data.response) {
                                    addAlbumsToPage(data.response);
                                }
                            });
                        }

                        function loadAlbum(album_id) {
                            getAudioList(album_id);
                        }

                        function addAlbumsToPage(albums) {
                            for (var i = 0; i < albums.length; i++) {
                                var a = $('<a></a>', {
                                    text: albums[i].title,
                                    onclick: 'loadAlbum(' + albums[i].album_id + ');',
                                    href: '#'
                                });
                                $("#albums").append(a).append('<br/>');
                            }
                        }

                        function loadProfileCallback(data) {
                            var profile = data.response[0];
                            showProfile(profile);
                        }

                        function loadProfile(id) {
                            VK.api("getProfiles",
                                    {uids: id},
                            loadProfileCallback
                                    );
                        }

                        function showProfile(user) {
                            $('#userinfo').html(
                                    "Музыка " +
                                    user.last_name + " " +
                                    user.first_name
                                    );
                        }

                        function getAudioList(album_id) {
                            album_id = (typeof(album_id) == 'number') ? album_id : '';
                            VK.api("audio.get", {count: 100, album_id: album_id}, function(data) {
                                if (data.response) {
                                    reloadAudioPlayer(data.response);
                                }
                            });
                        }

                        function getRecommendAudioList() {

                            var audio = getCurrentAudio();
                            var target_audio = (audio.length > 0) ? audio.attr('oid') + '_' + audio.attr('id') : '';
                            console.log(audio.attr('oid') + '_' + audio.attr('id'));
                            VK.api("audio.getRecommendations", {
                                count: 100,
                                shuffle: 1,
                                target_audio: target_audio
                            }, function(data) {
                                if (data.response) {
                                    reloadAudioPlayer(data.response);
                                }
                            });
                        }

                        function getCurrentAudio() {
                            return $("li.current");
                        }

                        function search1() {

                            var searchword = $('#search').val()
                            getSearchAudioList(searchword);
                        }

                        function getSearchAudioList(searchword) {

                            VK.api("audio.search", {count: 100, q: searchword}, function(data) {
                                if (data.response) {
                                    reloadAudioPlayer(data.response);
                                }
                            });
                        }

                        function getPopularAudioList() {

                            VK.api("audio.getPopular", {count: 100}, function(data) {
                                if (data.response) {
                                    reloadAudioPlayer(data.response);
                                }
                            });
                        }

                        function reloadAudioPlayer(array) {
                            initPlayer();
                            makeAudioList(array);
                            loadPlayer();
                        }

                        function initPlayer() {
                            var audio = $('<audio></audio>', {
                                id: 'player',
                                controls: "controls",
                            });
                            $("#audioUrl").html(audio);
                        }

                        function makeAudioList(array) {
                            for (var i = 0; i < array.length; i++) {
                                var source = $('<source />', {
                                    id: array[i].aid,
                                    owner_id: array[i].owner_id,
                                    type: "audio/mpeg",
                                    src: array[i].url,
                                    title: array[i].artist + ' - ' + array[i].title
                                });
                                $("#player").append(source);
                            }
                            jk = source;
                        }

                        function loadPlayer() {
                            $('audio,video').mediaelementplayer({
                                audioWidth: 500,
                                audioHeight: 30,
                                loop: true,
                                shuffle: true,
                                playlist: true,
                                startVolume: 0.8,
                                playlistposition: 'bottom',
                                features: [
                                    'playlistfeature',
                                    'prevtrack',
                                    'playpause',
                                    'nexttrack',
                                    'loop',
                                    'shuffle',
                                    'playlist',
                                    'current',
                                    'progress',
                                    'duration',
                                    'volume',
                                    'vk'
                                ],
                                success: function(mediaElement, domObject) {

                                    mediaElement.play();
                                    // add event listener
                                    mediaElement.addEventListener('pause', function(e) {

                                        console.log('pause');
                                        //stopRotate();

                                    }, false);
                                    mediaElement.addEventListener('play', function(e) {

                                        console.log('play');
                                        //startRotate();

                                    }, false);
                                    // call the play method
                                    //mediaElement.play();

                                },
                            });
                        }


                        VK.init({
                            apiId: 3668304
                        });
                        VK.Auth.getLoginStatus(authInfo);
                        VK.UI.button('login_button');
                        getRecommendAudioList();
                        loadAlbums();

        </script>


    </body>
</html>
